## 存储介质

存储层级呈金字塔型，越往上，越快，越小，越贵，离CPU越近，CPU访问越方便。

主存(Primary Storage)里的数据可以被CPU直接操作，主存储器包括寄存器、高速缓存、内存(Main memory)，主存按字节寻址。

二级存储器里的数据不能直接被CPU操作，必须先拷贝到主存中，二级存储器包括闪存(固态硬盘)、磁盘(机械硬盘)，二级存储器按块寻址。

三级存储器，磁带光盘网络云，按块寻址，可脱机。

<img src="ch7 存储管理.assets/image-20210525102419655.png" alt="image-20210525102419655" style="zoom:50%;" />

各级存储之间的数据交换：

<img src="ch7 存储管理.assets/image-20210525103020544.png" alt="image-20210525103020544" style="zoom:50%;" />

### 存储介质的分类：

易失存储器：电脑关机就没了，主存

非易失存储器：一直保存，二级存储器、三级存储器，数据库一般存在这里

### 硬盘导向的数据库存储

将数据存储在二级存储器，若要读写某数据，先将其加载进主存。

用缓冲池来做，可以做预取，DBMS对数据的访问模式更清楚，而OS则不清楚，即取了page3、page4，下一个可能取page5

## 2、数据库在硬盘上的表示

## 3、系统日志

## 4、Buffer Management  **重点**

缓冲池：内存中可用的区域被分为一系列固定大小的页，这块区域被称为缓冲池，缓冲池中的页称为页框(frames)

缓冲区管理器：负责将磁盘中的页按需要取到缓冲池中。当缓冲池满了，BM来决定将哪个页替换成新的页。

页表：页表追踪现在在BP中的页，存储的是页号和位置，页号到缓冲池中frames的映射（映射到的是真实页的一个copy），是缓冲池的一部分
页目录：是页号到位置的映射

BM为每一个frame维护两个变量

* pin_count：当前有多少请求在访问页面，若某页面的pin_count大于0，则现在不能把这个页踢出去
* dirty：标记某页被拷贝到BP后是否被更改

请求页（Page Requests）：

当有一个页请求来了之后，检查页表看看缓冲池中是否包含被请求的页。如果页P在BP中，增加P的pin_count。返回指向frame P的指针。

如果被请求的页不在BP里：

* 选替换页：用选择策略，选择一个pin_count=0的frame来替换，并增加此frame的pin_count
* 写回脏页：若选中的页的dirty位为1，将这个页写回磁盘
* 读请求页：将磁盘中被请求的页读进BP

如果BP中没有frame的pin_count=0，那么BM必须等，事实上，通常的做法是将请求此页的事务给中断。

页释放事务：减少那个页对应的frame的pin_count

页修改事务：将被修改页对应的frame的dirty位置为1

页替换策略：

当BM需要清空一个frame来为一个新的页腾出空间时，它必须决定把BP中的哪个页给踢出去

页替换策略可以极大程度地影响数据库操作花费的时间。

LRU替换策略：选最久未被使用的页面进行修改

时钟替换策略：是LRU的一个近似，但不需要为每一个页维护一个时间戳。
每一个frame有一个reference位，为0或1，当一个页被读进frame或是frame中的某个页被访问了，就将这个位置为1
有一个时针一直在转，转到哪个页，就将哪个页的reference位置为0
当BM寻找一个frame来替换的时候，选择第一个reference位为0的frame

预取：为了更高效地处理页请求，BM经常会预取一些可能在未来被访问的页，比如说当前被访问的页周围的页。